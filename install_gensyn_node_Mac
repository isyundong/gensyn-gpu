#!/bin/bash

set -e

echo "ğŸ§  RL-Swarm ä¸€é”®å®‰è£…è„šæœ¬ for Mac mini M4 (åŒ…å« Node.js + Yarn æ”¯æŒ)"

# Step 1: å®‰è£… Homebrewï¼ˆå¦‚æœæ²¡è£…ï¼‰
if ! command -v brew &> /dev/null; then
  echo "ğŸ“¦ å®‰è£… Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
  echo "âœ… Homebrew å·²å®‰è£…"
fi

# Step 2: å®‰è£… Python 3.10+
if ! command -v python3.10 &> /dev/null; then
  echo "ğŸ å®‰è£… Python 3.10..."
  brew install python@3.10
else
  echo "âœ… Python 3.10 å·²å®‰è£…"
fi

# Step 3: å®‰è£… Node.jsï¼ˆ18+ï¼‰
if ! command -v node &> /dev/null; then
  echo "ğŸ§± å®‰è£… Node.js..."
  brew install node
else
  echo "âœ… Node.js å·²å®‰è£…"
fi

# Step 4: å¯ç”¨ corepack å¹¶å®‰è£… Yarnï¼ˆæ¨èæ–¹å¼ï¼‰
echo "ğŸ§µ å¯ç”¨ Yarn æ”¯æŒ..."
corepack enable
corepack prepare yarn@stable --activate

# Step 5: å†™å…¥ Yarn PATHï¼ˆå¦‚æœªè‡ªåŠ¨ç”Ÿæ•ˆï¼‰
YARN_PATH_LINE='export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"'
if ! grep -q "$YARN_PATH_LINE" "$HOME/.zshrc"; then
  echo "$YARN_PATH_LINE" >> "$HOME/.zshrc"
  source "$HOME/.zshrc"
fi

# Step 6: æ£€æŸ¥ Yarn æ˜¯å¦æ­£å¸¸
if ! command -v yarn &> /dev/null; then
  echo "âŒ Yarn å®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ corepack å’Œ Node ç¯å¢ƒï¼"
  exit 1
fi
echo "âœ… Yarn å®‰è£…æˆåŠŸ"

# Step 7: å…‹éš†ä»“åº“
if [ ! -d "rl-swarm" ]; then
  echo "ğŸ” å…‹éš† gensyn-ai/rl-swarm ä»“åº“..."
  git clone https://github.com/gensyn-ai/rl-swarm.git
else
  echo "ğŸ“ rl-swarm å·²å­˜åœ¨ï¼Œè·³è¿‡å…‹éš†"
fi

cd rl-swarm

# Step 8: åˆ›å»º Python è™šæ‹Ÿç¯å¢ƒ
echo "ğŸ§ª åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
python3.10 -m venv .venv
source .venv/bin/activate

# Step 9: å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£… Python ä¾èµ–ï¼ˆCPU-only æ¨¡å¼ï¼‰..."
pip install --upgrade pip
pip install -r requirements.txt

# Step 10: å¯åŠ¨ RL-Swarm èŠ‚ç‚¹
echo "ğŸš€ å¯åŠ¨ RL-Swarm èŠ‚ç‚¹..."
echo "âš ï¸ å½“æç¤ºæ˜¯å¦åŠ å…¥ testnet æ—¶ï¼Œè¯·è¾“å…¥ Y æˆ–ç›´æ¥æŒ‰å›è½¦ã€‚"
sleep 2
bash run_rl_swarm.sh
